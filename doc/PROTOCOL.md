# SP^3 Protocol

## Protocol Overview

    Sender                  Server                    Client
    | --- Sender Hello --------> |
    |                            |                          |
    |                            | --- Challenge ---------> |
    |                            |                          |
    | <------ Challenge Relayed to sender ----------------  |
    |                            |                          |
    | -- Sender Authorization -> |
    |                            |
    | <-- Acknowledgement ------ |
    |                            |
    | ----- Packets -----------> |

The protocol begins with a Client Hello message. This is a JSON string where
the client specifies the destination address is wants to send packets to, and
the mechanism that it wants to use to get access to. The server will then relay
a challenge to the destination address. The sender then needs to retrieve
that challenge from the destination and use it to complete authorization from
the server.  Once authorization is granted, the client can send packets to the
destination via the server.

## Protocol Messages

### Sender Hello

This is a text string sent as a websocket frame which is the JSON encoding
of the following object:

```javascript
{
  "DestinationAddress": "<destination IP>"
  "AuthenticationMethod": 0
}
```
The list of AuthenticationMethod's is in protocol.go. The simplest is method 0,
where the challenge will be sent through an active websocket connection to the
destination, if one exists.  Other authentication methods are more complex, but
allow for delegation of authority to allow a destination to prove that a client
desiring to receive packets from SP^3 is running at a given IP address without
the need for direct communication between the destination and an SP^3 server.

### Challenge

The challenge for websocket Authentication is a JSON encoded message
with the following fields:

```javascript
{
  "Status": 0,
  "Challenge": "string"
}
```

The challenge is an opaque string, which must be sent back to the server by
the sender in a SenderAuthorization message.

### Sender Authorization

Authorization is performed through a JSON encoded message with the following
fields:

```javascript
{
  "DestinationAddress": "string",
  "Challenge": "string"
}
```

The destination address must be the same as in the SenderHello. The challenge
must be identical to the one generated by the server.

### Acknowledgement

If the authorization is successful, the server will respond with a message
indicating that ``` {"Status": 0} ```. Error status codes are documented in
`protocol.go`.

### Packets

Once the sender has been authorized, it should send packets
as binary frames over the websocket connection is has open to the SP^3 server.
These messages are Layer 3 packets - beginning with the IP header. The server
will ensure that there is a parseable IPv4 (IPv6 soon!) header, and that the
destination IP address is the one authenticated by the client. The network
configuration of the SP^3 server may place additional restrictions on packets
that can be sent by the server. For instance, routers are unlikely to support
source-routed or improperly check-summed packets.

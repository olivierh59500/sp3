<!DOCTYPE html>
<html>
  <head>
    <title>SP^3 Demo</title>
    <meta charset="utf-8" />
    <script src="packeteditor.js"></script>
    <script src="conversion.js"></script>
    <script type="text/javascript">
      var fields = [
        new ComputedField("Len", 4, 4, totalLength),
        new ComputedField("Chksum", 20, 4, ipChecksum),
        new PacketField("Src IP", 24, 8, hex2ip, ip2hex),
        new PacketField("Dest IP", 32, 8, hex2ip, ip2hex),
        new PacketField("Src Port", 40, 4, hex2port, port2hex),
        new PacketField("Dest Port", 44, 4, hex2port, port2hex),
        new ComputedField("Len", 48, 4, udpLength),
        new ComputedField("Chksum", 52, 4, udpChecksum),
        new VarLenField("Payload", 56, hex2ascii, ascii2hex)
      ];
      fields[8].background = '#cff';
      window.addEventListener('load', function () {
        var editor = new PacketEditor(document.getElementById("packet"), fields, 16);
        document.getElementById("send").addEventListener("click", doSend, true);
        document.getElementById("server").value = "ws://" + location.host + "/sp3";
      }, true);
      function externalip(dat) {
        console.log("Learned your IP is " + dat.ip);
        document.getElementById("destination").value=dat.ip;
        fields[3].value = fields[3].toHex(dat.ip);
        fields[3].onChange();
      }
      var connectState = 0;
      function doSend() {
        var socket = new WebSocket(document.getElementById("server").value);
        socket.onmessage = function(msg) {
          var data = JSON.parse(msg.data);
          if (data.Status === 0 && connectState === 1) { //okay
            var ip = document.getElementById("destination").value;
            socket.send(JSON.serialize({
              DestinationAddress: ip,
              Challenge: data.Challenge
            }));
            connectState = 2;
          } else if (data.Status === 0 && connectState === 2) {
            // Authorized and ready to send.
            var buf = hext2AB(document.getElementById("packet").value);
            socket.send(buf.buffer);
          } else if (data.Status > 1) { //error
            console.error("Server Error: " + data.Status);
            return;
          }
        };
        socket.onopen = function () {
          connectState = 1;
          var ip = document.getElementById("destination").value;
          socket.send(JSON.serialize({
            DestinationAddress: ip,
            AuthenticationMethod: 0
          }));
        };
      }
    </script>
    <script type="text/javascript" src="https://api.ipify.org?format=jsonp&callback=externalip"></script>
    <style type="text/css">
    .editorLine {
      display:block;
      font-size: 2em;
      padding-top: 0.8em;
    }
    </style>
  </head>
  <body>
    <header>
      <h1>SP<sup>3</sup></h1>
      <h3>A Simple, Practical, and Safe Packet Spoofing Protocol</h3>
    </header>
    <section>
      <h2>Instructions</h2>
      <p>
        This demo implements a combined Client and Sender. It instructs a
        remote SP<sup>3</sup> server to send it an arbitrarily crafted UDP
        packet as a demonstration of the protocol.
      </p>
      <p style="color:red">
        Note: The basic demonstration of this capability does not handle NAT
        translations, and will only work if your machine has a publically
        accessible IP address.
      </p>
      <p>
        First, choose a port, and listen for incoming traffic, using e.g.
        <code>
          nc -u -l 8080
        </code>.
        Next, verify the packet to be sent below has the expected host, and
        port automatically detected, and make other desired changes.
        Finally, send the packet, and if all goes well the payload will be
        displayed by netcat.
      </p>
    </section>
    <section id="demo">
      <h2>Demo</h2>
      <textarea id="packet">4500002914c800004011d00c0a00071c80d00404d7981f900015322f48656c6c6f20576f726c64210a</textarea>
      <hr>
      <label for="destination">Destination:</label><input type="text" id="destination" value="" /><br />
      <label for="server">SP3 Server:</label><input type="text" id="server" value="ws://localhost:8080" /><br />
      <input type="reset" value="Reset" />
      <input id="send" type="button" value="Send" />
    </section>
  </body>
</html>
